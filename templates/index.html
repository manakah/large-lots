{% extends "base.html" %}
{% load staticfiles %}
{% block title %}The City of Chicago is selling vacant residential lots for $1. Here's how you get one{% endblock %}
{% block extra_css %}
    <style id="map-styles">
      #parcels {
        polygon-fill: #6ac682;
        polygon-opacity: 0.7;
        line-color: #389250;
        line-width: 0.5;
        line-opacity: 1;
      }
    </style>
    <style id="map-styles-sold">
        #applied_parcels {
          polygon-fill: #A1285D;
          polygon-opacity: 0.7;
          line-color: #680D35;
          line-width: 0.5;
          line-opacity: 1;
        }
    </style>
{% endblock %}
{% block content %}
  <div class='col-md-12'>
    <br />
    <p class='lead'>The City of Chicago is selling vacant residential lots for <strong>$1</strong>.</p> <!-- Here's how you get one.</p> -->
    <hr>
    <p class='lead'>As part of the Fall 2016 Expansion, the City will sell nearly 1,000 lots. More information on a future round coming soon! Check back later this fall.</p>

    <p>
      <form class='form-inline hidden-print' id='lot-form'>
        <div class="form-group">
          <input class='form-control input-lg' id='search_address' placeholder='Enter your address' type='text' />
          <input class='btn btn-primary btn-lg' id='search' type='button' value='Search' />
        </div>
      </form>
    </p>

    <div class='row'>
      <div class='col-md-8'>
        <div id='map'></div>
      </div>
      <div class='col-md-4'>
        <div class='well' id='lot-info'>
          <p>To get started:</p>
          <ol>
            <li>Enter your address</li>
            <li>View lots near you</li>
            <li>Click on a lot for details</li>
          </ol>
        </div>
      </div>
    </div>

  </div>

    <!-- Modal -->
    <div class="modal fade" id="modalGeocode" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body">
            <p><strong id='addr_search_modal'></strong> is not in the Large Lots program area. Please try again.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">OK, thanks</button>
          </div>
        </div>
      </div>
    </div>

{% endblock %}
{% block extra_js %}
    <script type="infowindow/html" id="infowindow_template">
    <div class="cartodb-popup">
      <a href="#close" class="cartodb-popup-close-button close">x</a>
      <div class="cartodb-popup-content-wrapper">
        <div class="cartodb-popup-content">
          <h4>{{content.data.street_number}} {{content.data.street_dir}} {{content.data.street_name}} {{content.data.street_type}}</h4>
            <p>PIN: {{content.data.pin14}}<br />
            Zoned: {{content.data.zoning_classification}}<br />
            Sq Ft: {{content.data.sq_ft}}<br />
            Alderman: (Ward {{content.data.ward}})</p>
        </div>
      </div>
      <div class="cartodb-popup-tip-container"></div>
    </div>
    </script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false&libraries=places&v=3.17&key=AIzaSyCSg3bQurfz0U61uKn_8CYgPHzcl_Y2JE8"></script>
    <script src="{% static 'js/lib/jquery.address.js' %}"></script>
    <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
    <script src="{% static 'js/lib/leaflet.label.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/lib/leaflet-google.js' %}" ></script>
    <script src="{% static 'js/largelots_mapmaker.js' %}"></script>

    <script>
      $(function() {
        var init_params = {
            map_centroid: [41.7872, -87.6345],
            defaultZoom: 11,
            cartodb_table: 'large_lots_2016_fall_expansion',
            mainWhere: "",
            overlayName: "chicago_community_areas WHERE community = 'LARGE LOTS EXPANSION'",
            fields: 'pin, pin_nbr, street_name, street_direction, street_type, ward, square_feet, zone_class, community',
            sublayer: {
                sql: "select * from all_sold_lots",
                cartocss: $('#map-styles-sold').html().trim(),
                interactivity: 'pin, pin_nbr, street_name, street_direction, street_type, ward, community',
            }
        }

        // Overwrite object functions, before initializing
        LargeLots.createCartoLayer = function(layerOpts) {
          cartodb.createLayer(LargeLots.map, layerOpts, { https: true })
              .addTo(LargeLots.map)
              .done(function(layer) {
                    for (var i = 0; i < layer.getSubLayerCount(); i++) {
                      layerOpts[i] = layer.getSubLayer(i);
                      layerOpts[i].setInteraction(true);

                      layerOpts[i].on('featureOver', function(e, latlng, pos, data, subLayerIndex) {
                          $('#map div').css('cursor','pointer');
                          LargeLots.info.update(data);
                      });
                      layerOpts[i].on('featureOut', function(e, latlng, pos, data, subLayerIndex) {
                          $('#map div').css('cursor','inherit');
                          LargeLots.info.clear();
                      });
                      layerOpts[i].on('featureClick', function(e, pos, latlng, data){
                          LargeLots.getOneParcel(data['pin_nbr']);
                      });

                    }
                  // LargeLots.soldLayer = layer.getSubLayer(2);
                  // LargeLots.soldLayer.setInteraction(true);
                  // LargeLots.soldLayer.on('featureOver', function(e, latlng, pos, data, subLayerIndex) {
                  //     $('#map div').css('cursor','pointer');
                  //     LargeLots.info.update(data);
                  // });
                  // LargeLots.soldLayer.on('featureOut', function(e, latlng, pos, data, subLayerIndex) {
                  //     $('#map div').css('cursor','inherit');
                  //     LargeLots.info.clear();
                  // });
                  // LargeLots.soldLayer.on('featureClick', function(e, pos, latlng, data){
                  //     LargeLots.getOneParcel(data['pin_nbr']);
                  // });

                  // LargeLots.lotsLayer = layer.getSubLayer(0);
                  // LargeLots.lotsLayer.setInteraction(true);
                  // LargeLots.lotsLayer.on('featureOver', function(e, latlng, pos, data, subLayerIndex) {
                  //     $('#map div').css('cursor','pointer');
                  //     LargeLots.info.update(data);
                  // });
                  // LargeLots.lotsLayer.on('featureOut', function(e, latlng, pos, data, subLayerIndex) {
                  //     $('#map div').css('cursor','inherit');
                  //     LargeLots.info.clear();
                  // });
                  // LargeLots.lotsLayer.on('featureClick', function(e, pos, latlng, data){
                  //     LargeLots.getOneParcel(data['pin_nbr']);
                  // });

                  if($("#search_address").length != 0) {
                    window.setTimeout(function(){
                        if($.address.parameter('pin')){
                            LargeLots.getOneParcel($.address.parameter('pin'))
                        }
                    }, 1000)
                  };
              }).error(function(e) {
              console.log('ERROR')
              console.log(e)
            });
        };

        LargeLots.initialize(init_params);

      });

      var autocomplete = new google.maps.places.Autocomplete(document.getElementById('search_address'));

      $("#search").on("click", LargeLots.addressSearch);
      $("#search_address").on("keydown", function(e){
        if(e.keyCode == 13){
          LargeLots.addressSearch(e);
        }
      });

      $("#print-page").on("click", function(){ window.print(); });
    </script>
{% endblock %}
