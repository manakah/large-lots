{% extends "base.html" %}
{% load staticfiles %}
{% block title %}The City of Chicago is selling vacant residential lots for $1. Here's how you get one{% endblock %}
{% block extra_css %}
    <style id="map-styles">
      #parcels {
        polygon-fill: #6ac682;
        polygon-opacity: 0.7;
        line-color: #389250;
        line-width: 0.5;
        line-opacity: 1;
      }
    </style>
    <style id="map-styles-sold">
        #sold_parcels {
          polygon-fill: #A1285D;
          polygon-opacity: 0.7;
          line-color: #680D35;
          line-width: 0.5;
          line-opacity: 1;
        }
    </style>
    <style id="map-styles-applied">
        #applied_parcels {
          polygon-fill: #1C4A28;
          polygon-opacity: 0.7;
          line-color: #112C18;
          line-width: 0.5;
          line-opacity: 1;
        }
    </style>
{% endblock %}
{% block content %}
  <div class='col-md-12'>
    <br />
    <p class='lead'>The City of Chicago is selling vacant residential lots for <strong>$1</strong>.</p> <!-- Here's how you get one.</p> -->
    <p class='lead'>As part of the Fall 2016 Expansion, the City will sell nearly 1,000 lots. More information on a future round coming soon! Check back later this fall.</p>

    {% if application_active %}
      <p class='lead'>The current program has <span class="badge badge-green">{{current_count}}</span> lots available to buy. In previous programs, the City sold <span class="badge badge-purple">{{sold_count}}</span> lots.</p>
    {% else %}
      <p class='lead'>The City offered <span class="badge badge-green">{{current_count}}</span> lots in the most recent program. In previous programs, the City sold <span class="badge badge-purple">{{sold_count}}</span> lots.</p>
    {% endif %}

    <div class="row">  
      <div class="col-md-12"> 
        <hr> 
        <h3>Explore properties in the Large Lot program</h3>
        {% if application_active %}
          <p>This map shows the properties sold in previous programs and the properties available in the current program. Visit our <a href="{% url 'apply' %}">application page</a> to learn about buying a lot.</p>
        {% else %}
          <p>This map shows the properties sold in previous programs and the properties made available and/or under review in the most recent program. <strong>The City is not accepting applications for any lots shown below.</strong></p>
        {% endif %}

        <p>
          <form class='form-inline hidden-print' id='lot-form'>
            <div class="form-group">
              <input class='form-control input' id='search_address' placeholder='Enter your address' type='text' />
              <input class='btn btn-primary btn-sm' id='search' type='button' value='Search' />
            </div>
            <div class="form-group">
              <input id="sold" data-type='sold' class="toggle-parcels checkbox" type="checkbox" checked=true />
              <label for='sold'><span class="label label-sold">Sold</span></label>

              <input id="current" data-type='current' class="toggle-parcels checkbox" type="checkbox" checked=true />
              <label for='current'><span class="label label-current">
                {% if application_active %}Current program{% else %}Most recent program{% endif %}
              </span></label>

              <input id="applied" data-type='applied' class="toggle-parcels checkbox" type="checkbox" checked=true />
              <label for='applied'><span class="label label-applied">Under review</span></label>
            </div>
          </form>
        </p>
      </div>
    </div>

    <div class='row'>
      <div class='col-md-8'>
        <div id='map'></div>
      </div>
      <div class='col-md-4'>
        <div class='well' id='lot-info'>
          <p>To get started:</p>
          <ol>
            <li>Enter your address</li>
            <li>View lots near you</li>
            <li>Click on a lot for details</li>
          </ol>
        </div>
      </div>
    </div>

  </div>

    <!-- Modal -->
    <div class="modal fade" id="modalGeocode" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body">
            <p><strong id='addr_search_modal'></strong> is not in the Large Lots program area. Please try again.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">OK, thanks</button>
          </div>
        </div>
      </div>
    </div>

{% endblock %}
{% block extra_js %}
    <script type="infowindow/html" id="infowindow_template">
    <div class="cartodb-popup">
      <a href="#close" class="cartodb-popup-close-button close">x</a>
      <div class="cartodb-popup-content-wrapper">
        <div class="cartodb-popup-content">
          <h4>{{content.data.street_number}} {{content.data.street_dir}} {{content.data.street_name}} {{content.data.street_type}}</h4>
            <p>PIN: {{content.data.pin14}}<br />
            Zoned: {{content.data.zoning_classification}}<br />
            Sq Ft: {{content.data.sq_ft}}<br />
            Alderman: (Ward {{content.data.ward}})</p>
        </div>
      </div>
      <div class="cartodb-popup-tip-container"></div>
    </div>
    </script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false&libraries=places&v=3.17&key=AIzaSyCSg3bQurfz0U61uKn_8CYgPHzcl_Y2JE8"></script>
    <script src="{% static 'js/lib/jquery.address.js' %}"></script>
    <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
    <script src="{% static 'js/lib/leaflet.label.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/lib/leaflet-google.js' %}" ></script>
    <script src="{% static 'js/largelots_mapmaker.js' %}"></script>

    <script>
      var applied_pins = "{{applied_pins|safe}}".replace('{', '').replace('}', '');

      $(function() {
        var init_params = {
            map_centroid: [41.7872, -87.6345],
            defaultZoom: 11,
            cartodb_table: 'large_lots_2016_fall_expansion',
            mainWhere: "",
            overlayName: "chicago_community_areas WHERE community = 'LARGE LOTS EXPANSION'",
            fields: 'pin, pin_nbr, street_name, street_direction, street_type, ward, square_feet, zone_class, community',
            extra_sublayers: [{
                sql: "select * from all_sold_lots",
                cartocss: $('#map-styles-sold').html().trim(),
                interactivity: 'pin, pin_nbr, street_name, street_direction, street_type, ward, community, status',
            },
            {
                sql: "select * from large_lots_2016_fall_expansion where pin_nbr in (" + applied_pins + ")",
                cartocss: $('#map-styles-applied').html().trim(),
                interactivity: 'pin',
            }]
        }

        LargeLots.getOneParcel = function(pin_nbr){
            if (LargeLots.lastClickedLayer){
              LargeLots.map.removeLayer(LargeLots.lastClickedLayer);
            }
            
            console.log(pin_nbr)
            
            var sql = new cartodb.SQL({user: 'datamade', format: 'geojson'});
            // Query both Carto layers: current and sold.
            sql.execute('select * from ' + LargeLots.cartodb_table + ' where pin_nbr=' + pin_nbr + '::VARCHAR')
              .done(function(data){
                if (typeof data.features[0] != 'undefined') {
                  LargeLots.createParcelShape(data);
                }
              }).error(function(e){console.log(e)});

             sql.execute('select * from ' + 'all_sold_lots' + ' where pin_nbr=' + pin_nbr + '::VARCHAR')
              .done(function(data){
                if (typeof data.features[0] != 'undefined') {
                  LargeLots.createParcelShape(data);
                }
              }).error(function(e){console.log(e)});

            window.location.hash = 'browse';
        };

        LargeLots.createParcelInfo = function(props) {
            var address = LargeLots.formatAddress(props);
            var pin_formatted = LargeLots.formatPin(props.pin_nbr);
            var info = "<div class='row'><div class='col-xs-6 col-md-12'>\
              <table class='table table-bordered table-condensed'><tbody>\
                <tr><td>Address</td><td>" + address + "</td></tr>\
                <tr><td>PIN</td><td>" + pin_formatted + " (<a target='_blank' href='http://www.cookcountypropertyinfo.com/cookviewerpinresults.aspx?pin=" + props.pin_nbr + "'>info</a>)</td></tr>";
  
            info += "<tr><td>Community</td><td>" + props.community + "</td></tr>";
            info += "<tr><td>Ward</td><td>" + props.ward + "</td></tr>";                

            if (props.zone_class){
                info += "<tr><td>Zoned</td><td> Residential (<a href='http://secondcityzoning.org/zone/" + props.zone_class + "' target='_blank'>" + props.zone_class + "</a>)</td></tr>";
            }
            if (props.square_feet){
                info += "<tr><td>Sq ft</td><td>" + LargeLots.addCommas(Math.floor(props.square_feet)) + "</td></tr>";
            }
            if (props.status){
                info += "<tr><td>Status</td><td>" + props.status.toUpperCase() + "</td></tr>";                
            }
            
            info += "</tbody></table></div><div class='col-xs-6 col-md-12'>\
            <img class='img-responsive img-thumbnail' src='https://pic.datamade.us/" + props.pin_nbr + ".jpg' /></div></div>";

            return info
        };

        LargeLots.initialize(init_params);

      });

      var autocomplete = new google.maps.places.Autocomplete(document.getElementById('search_address'));

      $("#search").on("click", LargeLots.addressSearch);
      $("#search_address").on("keydown", function(e){
        if(e.keyCode == 13){
          LargeLots.addressSearch(e);
        }
      });

      $("#print-page").on("click", function(){ window.print(); });
    </script>
{% endblock %}
